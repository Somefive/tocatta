{"version":3,"sources":["../index.js"],"names":["app","pageDisplay1","pageDisplay2","require","config","paths","$","document","ready","PageDisplay","Vue","el","data","message","tmp","Messenger","host","port","callback","socket","WebSocket","onmessage","console","log","JSON","parse","readyState","setTimeout","send","PageManager","name","suffix","dict","pageFault","messenger","status","img","Image","src","onload","width","height","page_id","getFromServer","pageManager","measures","preload","get","page","interval","i","push","ImageClip","image","sx","sy","sWidth","sHeight","canvas_id","canvas","getElementById","clientHeight","clientWidth","ctx","getContext","centerX","centerY","imageClipCollection","clearRect","heightSum","forEach","element","scale","lastY","imageClip","realHeight","realWidth","offsetX","offsetY","drawImage","render"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Created by somefive on 17-6-30.\n */\nlet app = null;\nlet pageDisplay1 = null, pageDisplay2 = null;\nrequire.config({\n\tpaths: {\n\t\t'jquery': 'lib/jquery.min'\n\t}\n});\nrequire(['jquery'], function($){\n\t$(document).ready(function(){\n\t\tpageDisplay1 = new PageDisplay('page-display-canvas-1');\n\t\tpageDisplay2 = new PageDisplay('page-display-canvas-2');\n\t})\n});\nrequire(['lib/vue.min'], function(Vue){\n\tapp = new Vue({\n\t\tel: '#tocatta-app',\n\t\tdata: {\n\t\t\tmessage: 'Hello Tocatta!'\n\t\t}\n\t});\n});\nlet tmp;\nclass Messenger {\n\tconstructor(host = \"localhost\", port = 9050, callback) {\n\t\tthis.socket = new WebSocket(\"ws://\"+host+\":\"+port);\n\t\tthis.socket.onmessage = function(message) {\n\t\t\tconsole.log(\"AAA\");\n\t\t\tmessage = JSON.parse(message.data);\n\t\t\tconsole.log(message);\n\t\t\tcallback(message);\n\t\t}\n\t}\n\tsend(message) {\n\t\tif (this.socket.readyState !== 1) setTimeout(() => {this.send(message);});\n\t\telse this.socket.send(message);\n\t}\n}\n\nclass PageManager {\n\tconstructor(name, suffix=\"jpg\") {\n\t\tthis.name = name;\n\t\tthis.dict = {};\n\t\tthis.pageFault = false;\n\t\tthis.suffix = suffix;\n\t\tthis.messenger = new Messenger(\"localhost\", 9050, (message) => {\n\t\t\tif (message.status) {\n\t\t\t\tlet img = new Image();\n\t\t\t\timg.src = message.data;\n\t\t\t\tthis.dict[message.name] = img;\n\t\t\t\timg.onload = () => {console.log(message.name+\":\"+img.width+\"x\"+img.height)};\n\t\t\t} else {\n\t\t\t\tthis.pageFault = true;\n\t\t\t}\n\t\t});\n\t}\n\tget(page_id) {\n\t\tif (!this.dict[name+page_id]) {\n\t\t\tthis.getFromServer(page_id);\n\t\t}\n\t}\n\tgetFromServer(page_id) {\n\t\tthis.messenger.send(name+page_id+\".\"+this.suffix);\n\t}\n}\n\nlet pageManager = new PageManager('', 'jpg');\n\nlet measures = [];\nfunction preload() {\n\tpageManager.get(2);\n\tsetTimeout(() => {\n\t\tlet page = pageManager.dict[2];\n\t\tlet interval = page.height/5;\n\t\tfor (let i=0;i<5;++i)\n\t\t\tmeasures.push(new ImageClip(page, 0, i*interval, page.width, interval));\n\t}, 3000);\n}\npreload();\n\nclass ImageClip {\n\tconstructor(image, sx, sy, sWidth, sHeight) {\n\t\tthis.image = image;\n\t\tthis.sx = sx;\n\t\tthis.sy = sy;\n\t\tthis.sWidth = sWidth;\n\t\tthis.sHeight = sHeight;\n\t}\n}\n\nclass PageDisplay {\n\tconstructor(canvas_id) {\n\t\tthis.canvas = document.getElementById(canvas_id);\n\t\tthis.canvas.height = this.canvas.clientHeight;\n\t\tthis.canvas.width = this.canvas.clientWidth;\n\t\tthis.ctx = this.canvas.getContext('2d');\n\t\tthis.centerX = this.canvas.clientWidth/2;\n\t\tthis.centerY = this.canvas.clientHeight/2;\n\t\t// this.scale = 1.0;\n\t\tthis.imageClipCollection = [];\n\t}\n\tclear() {\n\t\tthis.imageClipCollection = [];\n\t\tthis.ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);\n\t}\n\trender() {\n\t\tthis.ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);\n\t\tlet heightSum = 0;\n\t\tthis.imageClipCollection.forEach((element) => {\n\t\t\theightSum += element.sHeight;\n\t\t});\n\t\tlet scale = (heightSum < 1) ? 1.0 : this.canvas.clientHeight/heightSum;\n\t\tlet lastY = 0;\n\t\tthis.imageClipCollection.forEach((element) => {\n\t\t\tlet imageClip = element;\n\t\t\tlet realHeight = imageClip.sHeight*scale;\n\t\t\tlet realWidth = imageClip.sWidth*scale;\n\t\t\tlet offsetX = this.centerX - realWidth/2;\n\t\t\tlet offsetY = lastY;\n\t\t\tlastY = offsetY + realHeight;\n\t\t\tconsole.log(imageClip);\n\t\t\tconsole.log(offsetX+\" \"+offsetY+\" \"+realWidth+\" \"+realHeight+\" \"+scale);\n\t\t\tthis.ctx.drawImage(imageClip.image,\n\t\t\t\timageClip.sx, imageClip.sy, imageClip.sWidth, imageClip.sHeight,\n\t\t\t\toffsetX, offsetY, realWidth, realHeight);\n\t\t});\n\t}\n\trescale(scale) {\n\t\tthis.scale = scale;\n\t\tthis.render();\n\t}\n}"]}