{"version":3,"sources":["../imageProcess.js"],"names":["PaintPattern","baseCanvas","pts","clear","ctx","beginPath","moveTo","canvas","width","interval","height","length","i","lineTo","stroke","ReshapedColorData","imageData","array","index","row","push","col","data","ImageProcess","rcd","smoothDepth","depth","total","color","value","normalize","smooth","dataSeq","depthThreshold","intervalThreshold","cbs","beginAt","min_start","max_start","_min","_max","cpy","ds","d1","d2","d3","d4","d5"],"mappings":"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","file":"imageProcess.js","sourcesContent":["/**\n * Created by somefive on 17-7-3.\n */\nclass PaintPattern {\n\tstatic drawLinesHorizontally(baseCanvas, pts) {\n\t\tbaseCanvas.clear();\n\t\tbaseCanvas.ctx.beginPath();\n\t\tbaseCanvas.ctx.moveTo(baseCanvas.ctx[0]*baseCanvas.canvas.width,0);\n\t\tlet interval = baseCanvas.canvas.height/pts.length;\n\t\tfor (let i=1;i<pts.length;++i) {\n\t\t\tbaseCanvas.ctx.lineTo(pts[i]*baseCanvas.canvas.width,i*interval);\n\t\t}\n\t\tbaseCanvas.ctx.stroke();\n\t}\n}\n\n/**\n * A class for reconstructed color data.\n */\nclass ReshapedColorData {\n\tconstructor(imageData) {\n\t\tlet array = [], index = 0;\n\t\tfor (let row=0;row<imageData.height;++row) {\n\t\t\tarray.push([]);\n\t\t\tfor (let col=0;col<imageData.width;++col) {\n\t\t\t\tarray[row].push([\n\t\t\t\t\timageData.data[index],\n\t\t\t\t\timageData.data[index+1],\n\t\t\t\t\timageData.data[index+2],\n\t\t\t\t\timageData.data[index+3]\n\t\t\t\t]);\n\t\t\t\tindex += 4;\n\t\t\t}\n\t\t}\n\t\tthis.data = array;\n\t\tthis.width = imageData.width;\n\t\tthis.height = imageData.height;\n\t}\n}\n\nclass ImageProcess {\n\t\n\t/**\n\t * Get the smoothed color depth of average image row\n\t * @param rcd Reshaped Color Data\n\t * @param smoothDepth\n\t * @returns {Array}\n\t */\n\tstatic getRowColorDepth(rcd, smoothDepth = 3) {\n\t\tlet depth = [];\n\t\tfor (let row=0;row<rcd.height;++row) {\n\t\t\tlet total = 0;\n\t\t\tfor (let col=0;col<rcd.width;++col) {\n\t\t\t\tlet color = rcd.data[row][col][0] + rcd.data[row][col][1] + rcd.data[row][col][2];\n\t\t\t\tcolor = color*rcd.data[row][col][3]/4/256/256;\n\t\t\t\tif (rcd.data[row][col][3] < 25) color = 1;\n\t\t\t\ttotal += color;\n\t\t\t}\n\t\t\tlet value = total/imageData.width;\n\t\t\tdepth.push(value);\n\t\t}\n\t\tdepth = ImageProcess.normalize(ImageProcess.smooth(ImageProcess.normalize(depth),smoothDepth));\n\t\treturn depth;\n\t}\n\t\n\t/**\n\t * Calculate continuous blocks position. list of [beginAt, length]\n\t * @param dataSeq\n\t * @param depthThreshold\n\t * @param intervalThreshold\n\t * @returns {Array}\n\t */\n\tstatic getContinuousBlocks(dataSeq, depthThreshold=0.98, intervalThreshold=5) {\n\t\tlet cbs = [];\n\t\tlet beginAt = -1;\n\t\tfor (let i=0;i<dataSeq.length;++i) {\n\t\t\tif (dataSeq[i] < depthThreshold) {\n\t\t\t\tif (beginAt == -1) beginAt = i;\n\t\t\t} else {\n\t\t\t\tif (beginAt >= 0 && (i-beginAt) > intervalThreshold) cbs.push([beginAt, i-beginAt]);\n\t\t\t\tbeginAt = -1;\n\t\t\t}\n\t\t}\n\t\treturn cbs;\n\t}\n\t\n\t/**\n\t * Normalize a sequence of data by shifting and stretching\n\t * @param dataSeq\n\t * @param min_start\n\t * @param max_start\n\t * @returns {Array}\n\t */\n\tstatic normalize(dataSeq, min_start = 1, max_start = 0) {\n\t\tlet _min = min_start, _max = max_start;\n\t\tfor (let i=0;i<dataSeq.length;++i) {\n\t\t\tif (dataSeq[i]<_min) _min = dataSeq[i];\n\t\t\tif (dataSeq[i]>_max) _max = dataSeq[i];\n\t\t}\n\t\tlet cpy = [];\n\t\tfor (let i=0;i<dataSeq.length;++i) cpy.push((dataSeq[i]-_min)/(_max-_min));\n\t\treturn cpy;\n\t}\n\t\n\t/**\n\t * Smooth a sequence of data\n\t * @param dataSeq\n\t * @param depth\n\t * @returns {Array}\n\t */\n\tstatic smooth(dataSeq, depth=1) {\n\t\tlet cpy = [], ds = dataSeq;\n\t\twhile (depth > 0) {\n\t\t\tfor (let i=0;i<ds.length;++i) {\n\t\t\t\tlet d1 = (i-2)>=0?ds[i-2]:1;\n\t\t\t\tlet d2 = (i-1)>=0?ds[i-1]:1;\n\t\t\t\tlet d3 = ds[i];\n\t\t\t\tlet d4 = (i+1)<ds.length?ds[i+1]:1;\n\t\t\t\tlet d5 = (i+2)<ds.length?ds[i+2]:1;\n\t\t\t\tlet value = d1*0.1+d2*0.2+d3*0.4+d4*0.2+d5*0.1;\n\t\t\t\tcpy.push(value);\n\t\t\t}\n\t\t\tds = cpy;\n\t\t\tcpy = [];\n\t\t\tdepth -= 1;\n\t\t}\n\t\treturn ds;\n\t}\n}"]}